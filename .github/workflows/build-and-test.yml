---
name: Build & Test

on:
  pull_request:
  push:

jobs:
  build-and-test:
    name: ${{ matrix.image }} (${{ matrix.compiler }} Compiler Collection)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - 'amazonlinux:2'
          - 'almalinux:8'
          - 'centos:7'
          - 'rockylinux:8'
          - 'debian:bookworm'
          - 'debian:bullseye'
          - 'debian:buster'
          - 'fedora:34'
          - 'fedora:35'
          - 'fedora:36'
          - 'ubuntu:20.04'
          - 'ubuntu:21.04'
        compiler:
          - GNU
          - LLVM
        on_default_branch:
          - ${{ contains(github.ref, 'master') || contains(github.ref, 'develop') }}
        include:
          - compiler: GNU
            image: 'ubuntu:22.04'
          - compiler: LLVM
            image: 'ubuntu:22.04'
        exclude:
          - on_default_branch: false
      fail-fast: false
    container:
      env:
        CC: ${{ matrix.compiler == 'GNU' && 'gcc' || 'clang' }}
        CXX: ${{ matrix.compiler == 'GNU' && 'g++' || 'clang++' }}
      image: ${{ matrix.image }}
    steps:
      - name: Install `git` (Amazon Linux 2)
        run: yum --assumeyes install git
        if: ${{ startsWith(matrix.image, 'amazonlinux:') }}

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Dependencies (AlmaLinux/Amazon Linux/CentOS/Rocky Linux)
        uses: ./.github/actions/yum/install
        with:
          dependencies: epel-release
          groups: >-
            ${{ env.centos-build-group-dependencies }}
          packages: >-
            ${{ env.centos-build-dependencies }}
            ${{ matrix.compiler == 'GNU' && 'gcc gcc-c++' || 'clang' }}
            ${{ env.centos-mapnik-build-dependencies }}
            ${{ env.centos-test-dependencies }}
        if: |
          startsWith(matrix.image, 'almalinux:') ||
          startsWith(matrix.image, 'amazonlinux:') ||
          startsWith(matrix.image, 'centos:') ||
          startsWith(matrix.image, 'rockylinux:')

      - name: Install Dependencies (Debian)
        uses: ./.github/actions/apt-get/install
        with:
          packages: >-
            ${{ env.debian-build-dependencies }}
            ${{ matrix.compiler == 'GNU' && 'gcc g++' || 'clang' }}
            ${{ env.debian-test-dependencies }}
        if: ${{ startsWith(matrix.image, 'debian:') }}

      - name: Install Dependencies (Fedora)
        uses: ./.github/actions/yum/install
        with:
          groups: >-
            ${{ env.fedora-build-group-dependencies }}
          packages: >-
            ${{ env.fedora-build-dependencies }}
            ${{ matrix.compiler == 'GNU' && 'gcc gcc-c++' || 'clang' }}
            ${{ env.defora-test-dependencies }}
        if: ${{ startsWith(matrix.image, 'fedora:') }}

      - name: Install Dependencies (Ubuntu)
        uses: ./.github/actions/apt-get/install
        with:
          packages: >-
            ${{ env.ubuntu-build-dependencies }}
            ${{ matrix.compiler == 'GNU' && 'gcc g++' || 'clang' }}
            ${{ env.ubuntu-test-dependencies }}
        if: ${{ startsWith(matrix.image, 'ubuntu:') }}

      - name: Build `mapnik` (AlmaLinux/Amazon Linux/CentOS/Rocky Linux)
        uses: ./.github/actions/mapnik/build-and-install
        with:
          version: ${{ env.centos-mapnik-build-version }}
        if: |
          startsWith(matrix.image, 'almalinux:') ||
          startsWith(matrix.image, 'amazonlinux:') ||
          startsWith(matrix.image, 'centos:') ||
          startsWith(matrix.image, 'rockylinux:')

      - name: Build `mod_tile`
        uses: ./.github/actions/build

      - name: Test `mod_tile`
        uses: ./.github/actions/test

      - name: Install `mod_tile`
        uses: ./.github/actions/install

env:
  centos-build-group-dependencies: >-
    "Development Tools"
  centos-build-dependencies: >-
    cairo-devel
    cmake3
    glib2-devel
    httpd-devel
    iniparser-devel
    libcurl-devel
    libmemcached-devel
    librados2-devel
  centos-test-dependencies: >-
    httpd
    procps
  centos-mapnik-build-dependencies: >-
    boost-devel
    freetype-devel
    gdal-devel
    harfbuzz-devel
    libicu-devel
    libjpeg-turbo-devel
    libpng-devel
    libtiff-devel
    libwebp-devel
    libxml2-devel
    postgresql-devel
    proj-devel
    python2
    python3
    sqlite-devel
    zlib-devel
  centos-mapnik-build-version: 3.0.22
  debian-build-dependencies: >-
    apache2-dev
    cmake
    libcairo2-dev
    libcurl4-gnutls-dev
    libglib2.0-dev
    libiniparser-dev
    libmapnik-dev
    libmemcached-dev
    librados-dev
  debian-test-dependencies: >-
    apache2
  fedora-build-group-dependencies: >-
    "C Development Tools and Libraries"
    "Development Libraries"
    "Development Tools"
  fedora-build-dependencies: >-
    cairo-devel
    cmake
    glib2-devel
    httpd-devel
    iniparser-devel
    libcurl-devel
    libmemcached-devel
    librados-devel
    mapnik-devel
  fedora-test-dependencies: >-
    httpd
  ubuntu-build-dependencies: >-
    apache2-dev
    cmake
    libcairo2-dev
    libcurl4-gnutls-dev
    libglib2.0-dev
    libiniparser-dev
    libmapnik-dev
    libmemcached-dev
    librados-dev
  ubuntu-test-dependencies: >-
    apache2
