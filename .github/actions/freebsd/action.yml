---
inputs:
  build-dependencies:
    default:  >-
      apache24
      cairo
      cmake
      coreutils
      curl
      glib
      iniparser
      libmemcached
      mapnik
      pkgconf
    description: List of build dependency package(s) to install

runs:
  using: composite
  steps:
    - name: Install dependencies, Build, Test & Install `mod_tile`
      uses: vmactions/freebsd-vm@v0.3.0
      with:
        mem: 4096
        prepare: |
          mkdir -p /usr/local/etc/pkg/repos
          sed 's#/quarterly#/latest#g' /etc/pkg/FreeBSD.conf > /usr/local/etc/pkg/repos/FreeBSD.conf
          pkg upgrade --yes
          pkg install --yes ${{ inputs.build-dependencies }}
        release: 13.1
        run: |
          export CMAKE_BUILD_PARALLEL_LEVEL=$(sysctl -n hw.ncpu)
          export LIBRARY_PATH=/usr/local/lib
          cmake -B build -S . \
            -LA \
            -DCMAKE_BUILD_TYPE:STRING=${BUILD_TYPE:-Release} \
            -DCMAKE_INSTALL_PREFIX:PATH=${INSTALL_PREFIX:-/usr/local} \
            -DENABLE_TESTS:BOOL=ON
          cmake --build build
          ctest --test-dir build
          cmake --install build
        usesh: true
